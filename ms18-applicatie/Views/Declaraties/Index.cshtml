<h1>@ViewData["Title"]</h1>

<div id="login-user" class="hidden">
    <p>Hallo <span rel="name"></span>!</p>    

    <p>Hier kan je je bonnetjes inleveren:</p>

    <p><a asp-action="Nieuw"><button class="btn btn-primary">Nieuwe declaratie</button></a></p>

    <p>Dit zijn je bestaande declaraties in de database:</p>

    <table id="user-receipts">
        <tr>
            <th>Bedrag</th>
            <th>Opmerking</th>
            <th>Status</th>
            <th></th>
        </tr>
        
        <tr id="user-receipts-empty" class="hidden">
            <td colspan="999">Je hebt nog geen bonnetjes ingeleverd.</td>
        </tr>
        
        <tr id="user-receipts-row" class="hidden">
            <td rel="amount::euro"></td>
            <td rel="note"></td>
            <td rel="status"></td>
            <td class="user-receipts-actions">
                <a rel="id:href:editUrl">Aanpassen</a>
                <a rel="id:data-id" href="#" class="delete-link">Verwijderen</a>
            </td>
        </tr>
    </table>
</div>

@section scripts {
<script>
    apiGet('Session').then(member => {
        // User session loaded
     
        showOutput(member, document.querySelector('#login-user'));
        
        apiGet('Receipt').then(receipts => {
            // Receipts data loaded

            let noReceipts = (!receipts || !receipts.length);
            let receiptsTable = document.querySelector('#user-receipts');
            document.querySelector('#user-receipts-empty').className = noReceipts ? '' : 'hidden';
            for (id in receipts) {
                let receipt = document.querySelector('#user-receipts-row').cloneNode(true);
                receipt.id = 'user-receipts-' + receipts[id].id;
                receipt.className = '';
                showOutput(receipts[id], receipt);
                receiptsTable.appendChild(receipt);
            }
            receiptsTable.className = '';
            receiptsTable.querySelectorAll('.delete-link').forEach(deleteLink => deleteLink.addEventListener('click', event => {
                // Click Delete link

                event.preventDefault();

                if (!window.confirm('Weet je zeker dat je deze declaratie wilt verwijderen?'))
                    return;

                const receiptRow = receiptsTable.querySelector('#user-receipts-' + deleteLink.dataset.id);
                receiptRow.querySelector('.user-receipts-actions').className = 'hidden';

                apiDelete('Receipt/' + deleteLink.dataset.id).then(result => {
                    if (!result)
                        return;
                    receiptRow.remove();
                })
            }));
        });
    });
</script>
}